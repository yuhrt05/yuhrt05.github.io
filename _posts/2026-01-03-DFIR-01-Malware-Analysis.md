---
title: "DFIR LAB 01: Malware Analysis"
date: 2026-01-03 14:00:00 +0700
categories: [DFIR, Malware, ]
tags: [malware analysis, static analysis, dynamic analysis, autoruns, mitre-attack, persistence]
image: /assets/images8/banner.jpg
toc: true
layout: post
---

# 1. Lý thuyết

| Tab trong Autoruns | Mô tả chi tiết nội dung |
| :--- | :--- |
| **Everything** | Hiển thị tổng hợp tất cả các mục từ tất cả các tab khác trong một danh sách duy nhất. |
| **Logon** | Các điểm khởi động khi người dùng đăng nhập (Registry Run, RunOnce, Startup folder). |
| **Explorer** | Các tiện ích mở rộng cho File Explorer như Shell Extensions, Context Menu, Icon Overlays. |
| **Internet Explorer** | Các Browser Helper Objects (BHOs), Toolbars và Extensions nạp cùng IE. |
| **Scheduled Tasks** | Các tác vụ được lập lịch thực hiện bởi Task Scheduler (thường ở `\Microsoft\Windows`). |
| **Services** | Các dịch vụ hệ thống khởi chạy ở chế độ nền cùng Windows. |
| **Drivers** | Các trình điều khiển thiết bị (Drivers) được nạp vào nhân hệ điều hành (Kernel). |
| **Codecs** | Các thư viện hỗ trợ giải mã âm thanh và hình ảnh (Audio/Video Codecs). |
| **Boot Execute** | Các ứng dụng chạy ngay sau khi boot, trước khi nạp giao diện (ví dụ: `autochk`). |
| **Image Hijacks** | Cơ chế IFEO (Image File Execution Options) dùng để ghi đè việc thực thi file. |
| **AppInit** | Các DLL được nạp vào mọi tiến trình sử dụng thư viện `User32.dll`. |
| **KnownDLLs** | Các DLL hệ thống mà Windows coi là an toàn và nạp trực tiếp từ bộ nhớ đệm. |
| **Winlogon** | Các DLL và thành phần nạp cùng quá trình đăng nhập hệ thống (Winlogon notifications). |
| **Winsock Providers** | Các giao thức và dịch vụ mạng cấp thấp (Layered Service Providers). |
| **Print Monitors** | Các thư viện DLL nạp cùng dịch vụ in ấn (Spooler service). |
| **LSA Providers** | Các thành phần liên quan đến bảo mật và xác thực (Local Security Authority). |
| **Network Providers** | Các thành phần đăng ký dịch vụ mạng và xác thực tài khoản mạng. |
| **WMI** | Các sự kiện và hành động đăng ký qua Windows Management Instrumentation. |
| **Office** | Các Add-ins tự động nạp khi mở các ứng dụng Microsoft Office (Word, Excel...). |

# 2. Thực hành

## 2.1. Tổng quan 

| Trường thông tin | Mô tả |
|---|---|
| **Tên malware** | McAfee.exe |
| **Loại malware** | Remote Access Trojan (RAT) / Spyware |
| **Kỹ thuật chính** | DLL Side-loading |
| **Tệp tin liên quan** | `McAfee.exe` (File sạch), `McUtil.dll` (DLL Loader), `McUtil.dll.mc` (Payload shellcode) |
| **Hành vi chính** | Persistence; Process Injection; LAN scanning; C2 Server|
| **Mức độ nguy hiểm** | Cao (Có khả năng đánh cắp thông tin và lây lan trong mạng nội bộ) |
| **Hệ điều hành** | Windows |

## 2.2 Tiến hành phân tích
### 2.2.2. Phân tích tĩnh cơ bản

| Tên tệp | SHA256 Hash | Đặc điểm nhận dạng |
|---|---|---|
| McAfee.exe | `3124FCB79DA0BDF9D0D1995E37B06F7929D83C1C4B60E38C104743BE71170EFE` | Tệp thực thi hợp lệ, đóng vai trò "vùng đệm" |
| McUtil.dll | `b04d5b8d83246acef2fa3553bdaa16ee212a20090c0524a1e3db6a583732e4af` | Thư viện Loader, không có chữ ký số |
| McUtil.dll.mc | `58648fed34d7617c3217af047f331cb8e16012b8ae7d4fdebf77e31f6fa79cb5` | Tệp shellcode chính đã bị làm rối (Obfuscated) |

- Mã độc lợi dụng sự tin tưởng của hệ thống vào `McAfee.exe` có chữ ký số hợp lệ để nạp `file DLL` độc hại cùng tên trong cùng thư mục là `McUtil.dll`.

![image](assets/images8/1.png)

- Dùng `PEstudio` để trích xuất ra các hàm/API đã được import trong `McUtil.dll`: Đây là một `DLL 32-bit` hoạt động như một `loader/unpacker`: dùng `VirtualAlloc/VirtualProtect` và `GetProcAddress/GetModuleHandleA` với `import` từ `KERNEL32` để `giải nén/cấp phát vùng nhớ` và `tiêm mã độc` vào bộ nhớ

![image](assets/images8/2.png)

### 2.2.3. Phân tích động

- Thực hiện trong môi trường `VM`. Chạy trực tiếp file `McAfee.exe` trong thư mục cùng chứa 2 file là `McUtil.dll` và `McUtil.dll.mc` với quyền `Administrator`

Dùng `Process Monitor` để bắt được luồng thực thi theo thời gian thực và `filter` chỉ riêng với `Process Name` là `McAfee.exe`

![image](assets/images8/3.png)

- Xem qua một lượt ta có thể thấy rõ được 2 `giai đoạn chính` của quá trình thực thi

#### Giai đoạn kích hoạt

- Địa điểm hoạt động: Chủ yếu là trong `C:\Users\noname\Downloads\malware\`

![image](assets/images8/4.png)

- Hành vi quan trọng: Mã độc tạo một mapping cho `McUtil.dll` với quyền `PAGE_EXECUTE_READWRITE`

- Load Image: Xác nhận `McUtil.dll` đã được nạp vào không gian bộ nhớ của `McAfee.exe`

- ReadFile: Nó bắt đầu đọc file và thực thi payload `McUtil.dll.mc` (Offset 0, length hơn `116k bytes`)

#### Giai đoạn persistence

- Xuất hiện đường dẫn mới: `C:\ProgramData\McAfee\`

![image](assets/images8/5.png)

- Hành vi quan trọng: Nó đang tạo ra các thư mục mới tên là `McAfee` và thực hiện sao chép y nguyên chính nó gồm 3 file gốc vào trong `C:\ProgramData`. Đây là thư mục ẩn, thường được malware dùng để lẩn trốn để thiết lập cơ chế `persistence`.

Trong `Autoruns`, ta có thể dễ dàng thấy file `McAfee.exe` vẫn được `Verified` vì nó không bị chỉnh sửa mã nguồn nên vẫn hoàn toàn hợp pháp.

![image](assets/images8/6.png)

- Vị trí Registry: `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`

Check thử theo đường dẫn tại `C:\ProgramData\McAfee` bằng `Explorer` thì không thấy có `folder` nào tên `McAfee`

![image](assets/images8/12.png)

Mình thử check trên `cmd` thì thấy vẫn xuất hiện

![image](assets/images8/13.png)

Tìm hiểu một chút thì mình có được kĩ thuật mà `malware` sử dụng tại [Hide Artifacts: Hidden Files and Directories](https://attack.mitre.org/techniques/T1564/001/)

- Thuộc tính SH: Mã độc đã thiết lập hai thuộc tính quan trọng cho thư mục này là `System (S)` và `Hidden (H)`.

![image](assets/images8/14.png)

Vẫn tiếp tục trong `Process Monitor`, thấy được `malware` đang thực hiện `Process Injection` trực tiếp vào một phần mềm hợp pháp của hệ thống là `C:\Windows\SysWOW64\svchost.exe`

![image](assets/images8/7.png)

- Dấu hiệu đặc trưng: Hành động `CreateFileMapping` với quyền `PAGE_EXECUTE_READWRITE` lên svchost.exe.

- Lệnh `Process Create` đã tạo ra một tiến trình `svchost.exe` mới `(PID 6856)`.

- Mục đích: Mã độc sử dụng tiến trình `svchost.exe` (một tiến trình nền phổ biến của Windows) làm `vỏ bọc` để thực thi các hành vi độc hại ẩn dưới danh nghĩa hệ thống, nhằm qua mặt người dùng và các phần mềm giám sát đơn giản.

Chuyển sang `Process Explorer` ta có thể thấy được hành vi của tiến trình `svchost` được sinh ra bởi `malware`

![image](assets/images8/8.png)

- Hành vi Quét mạng (LAN Scanning / Discovery):
    - Tiến trình bị tiêm mã `svchost.exe` đang liên tục gửi các gói tin `TCP SYN` tới các địa chỉ `IP` trong mạng nội bộ (cụ thể là `192.168.129.x`) qua cổng `1357`.
    - Trạng thái `SYN_SENT` cho thấy mã độc đang cố gắng dò tìm các thiết bị đang hoạt động hoặc các dịch vụ đang mở trong mạng LAN nhưng chưa nhận được phản hồi
    - Mục đích: Đây là giai đoạn `Reconnaissance` (Thám mã nội bộ). Mã độc sau khi xâm nhập vào một máy sẽ tìm cách lây lan sang các máy khác trong cùng mạng hoặc tìm kiếm các máy chủ có lỗ hổng để thực hiện bước tiếp theo.

Kết hợp với những hành vi của `malware` thực hiện ở nội bộ thì nó cũng có những kết nối đến `C2 server` để nhận tín hiệu

![image](assets/images8/9.png)

- Máy nạn nhân `192.168.129.128` thực hiện truy vấn `DNS` cho tên miền: `asia.dcsvn.org`
- Kết quả phân giải: Tên miền này trỏ về các địa chỉ IP công cộng: `76.223.54.146` và `13.248.169.48` đây chính là địa chỉ của `C2 server`

Tiếp theo, thực hiện `HTTP GET request` tới cổng `443` và địa chỉ IP là địa chỉ của `C2 Server`

![image](assets/images8/10.png)

- Điểm bất thường: Thông thường cổng `443` dành cho `HTTPS` (mã hóa SSL/TLS). Ở đây, mã độc sử dụng `HTTP` thuần (không mã hóa) trên cổng `443`.
- Mục đích: Đây là kỹ thuật ẩn mình (`Evasion`) nhằm đánh lừa các hệ thống tường lửa hoặc giám sát mạng chỉ kiểm tra số cổng mà không kiểm tra nội dung gói tin (`Deep Packet Inspection`), khiến lưu lượng này trông giống như duyệt web bảo mật thông thường.

#### Tổng hợp quá trình phân tích động

| STT | Phase | Hành vi chi tiết (Behavior) | Công cụ xác nhận | Dấu hiệu (Artifacts/IoCs) |
| :--- | :--- | :--- | :--- | :--- |
| **1** | **DLL Side-loading** | `McAfee.exe` (tệp tin hợp lệ bị lợi dụng) nạp `McUtil.dll` (tệp tin độc hại) từ cùng thư mục thực thi. | ProcMon / ProcExp | `McUtil.dll` nằm ngoài thư mục hệ thống chuẩn. |
| **2** | **Unpacking / Decoding** | Giải mã shellcode từ tệp `.mc`. Cấp phát và thay đổi quyền vùng nhớ thành **RWX** (`PAGE_EXECUTE_READWRITE`). | PEStudio / ProcMon | Hàm `VirtualProtect`, `VirtualAlloc`, `CreateFileMapping`. |
| **3** | **Staging & Stealth** | Thư mục "tàng hình" trong File Explorer; lệnh attrib hiện mã SH. | ProcMon/CMD/Explorer | Tệp tin xuất hiện tại `C:\ProgramData\McAfee\`. |
| **4** | **Persistence** | Ghi giá trị vào Registry để mã độc tự khởi động lại cùng hệ thống Windows. | Autoruns / ProcMon | Key: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`. |
| **5** | **Process Injection** | Sử dụng kỹ thuật **Process Hollowing** để tiêm mã độc từ `McAfee.exe` vào tiến trình hệ thống `svchost.exe`. | ProcExp / ProcMon | `svchost.exe` có tiến trình cha (Parent) đã kết thúc hoặc không hợp lệ. |
| **6** | **Internal Reconnaissance** | Tiến trình `svchost.exe` thực hiện quét dải mạng LAN để tìm kiếm các máy trạm khác. | ProcExp (TCP/IP) | Quét TCP Port **1357** tới các IP nội bộ `192.168.129.x`. |
| **7** | **Command & Control (C2)** | Truy vấn DNS và gửi tín hiệu Beaconing về máy chủ điều khiển của kẻ tấn công. | Wireshark | Domain: `asia.dcsvn.org`; Giao thức **HTTP GET** qua Port **443**. |

---

### 2.2.4. Phân tích tĩnh nâng cao

- Vì `McAfee.exe` là một tệp tin hợp pháp và có chữ ký số, kẻ tấn công đã lợi dụng nó làm để nạp mã độc. Để hiểu rõ việc cách thức này kích hoạt mã độc bên trong, ta sẽ kết hợp `phân tích tĩnh` (sử dụng mã giả từ IDA) để soi luồng thực thi của `McUtil.dll`, từ đó làm tiền đề cho việc `Phân tích động` bằng các trình `Debugger` về sau.

```c
int sub_10001000()
{
  HMODULE ModuleHandleA; // eax
  LPVOID (__stdcall *VirtualAlloc)(LPVOID, SIZE_T, DWORD, DWORD); // eax
  WCHAR *v2; // esi
  HMODULE v3; // eax
  LPWSTR (__stdcall *lstrcpyW)(LPWSTR, LPCWSTR); // eax
  DWORD v5; // ecx
  HMODULE v6; // eax
  HANDLE (__stdcall *CreateFileW)(LPCWSTR, DWORD, DWORD, LPSECURITY_ATTRIBUTES, DWORD, DWORD, HANDLE); // eax
  HMODULE v8; // eax
  BOOL (__stdcall *ReadFile)(HANDLE, LPVOID, DWORD, LPDWORD, LPOVERLAPPED); // eax
  __int64 v10; // rax
  int v11; // ecx
  HMODULE v12; // eax
  void (__stdcall *Sleep)(DWORD); // eax
  int v15; // [esp+0h] [ebp-18h]
  int v16; // [esp+4h] [ebp-14h]
  _DWORD v17[2]; // [esp+8h] [ebp-10h] BYREF
  HANDLE v18; // [esp+10h] [ebp-8h]
  DWORD ModuleFileNameW; // [esp+14h] [ebp-4h] BYREF
  int savedregs; // [esp+18h] [ebp+0h] BYREF

  ModuleHandleA = GetModuleHandleA("kernel32.dll");
  VirtualAlloc = (LPVOID (__stdcall *)(LPVOID, SIZE_T, DWORD, DWORD))GetProcAddress(ModuleHandleA, "VirtualAlloc");
  v2 = (WCHAR *)VirtualAlloc(0, 1048699, 4096, 64);
  ModuleFileNameW = GetModuleFileNameW(0, v2, 0x101Bu);
  v3 = GetModuleHandleA("kernel32.dll");
  lstrcpyW = (LPWSTR (__stdcall *)(LPWSTR, LPCWSTR))GetProcAddress(v3, "lstrcpyW");
  v5 = --ModuleFileNameW;
  if ( ModuleFileNameW )
  {
    while ( v2[v5] != 92 )
    {
      ModuleFileNameW = --v5;
      if ( !v5 )
        goto LABEL_6;
    }
    lstrcpyW(&v2[v5 + 1], L"McUtil.dll.mc");
  }
LABEL_6:
  v6 = GetModuleHandleA("kernel32.dll");
  CreateFileW = (HANDLE (__stdcall *)(LPCWSTR, DWORD, DWORD, LPSECURITY_ATTRIBUTES, DWORD, DWORD, HANDLE))GetProcAddress(v6, "CreateFileW");
  v18 = CreateFileW(v2, 0x80000000, 1, 0, 3, 0, 0);
  if ( v18 != (HANDLE)-1 )
  {
    v17[1] = v2;
    v8 = GetModuleHandleA("kernel32.dll");
    ReadFile = (BOOL (__stdcall *)(HANDLE, LPVOID, DWORD, LPDWORD, LPOVERLAPPED))GetProcAddress(v8, "ReadFile");
    v10 = ((__int64 (__stdcall *)(HANDLE, WCHAR *, int, DWORD *, _DWORD, int, int))ReadFile)(
            v18,
            v2,
            1048699,
            &ModuleFileNameW,
            0,
            v15,
            v16);
    ((void (__cdecl *)(_DWORD, _DWORD, _DWORD, int, FARPROC (__stdcall *)(HMODULE, LPCSTR), _DWORD *, int *, HMODULE (__stdcall *)(LPCSTR), WCHAR *))v2)(
      0,
      v10,
      HIDWORD(v10),
      v11,
      GetProcAddress,
      v17,
      &savedregs,
      GetModuleHandleA,
      v2);
    v12 = GetModuleHandleA("kernel32.dll");
    Sleep = (void (__stdcall *)(DWORD))GetProcAddress(v12, "Sleep");
    ((void (__cdecl *)(int))Sleep)(-1);
  }
  return 0;
}
```
### Luồng thực thi mã độc

![image](assets/images8/15.png)

File cần debug là `McAfee.exe`, mình dùng `x32Dbg` để thực hiện

![image](assets/images8/16.png)

- Nhấn `Ctrl + G` để nhảy đến hàm `LoadLibrary` 

![image](assets/images8/17.png)

- Tiến hành đặt `breakpoint` tại địa chỉ `75191966`, dùng để chặn bắt thời điểm `McUtil.dll` được nạp vào bộ nhớ nhằm kiểm soát và phân tích hành vi thực thi của mã độc.

![image](assets/images8/38.png)

Nhấn `F9`, thấy dừng tại `Entry Point (004046E6)`: Điểm bắt đầu thực thi logic chính của `McAfee.exe` để chuẩn bị nạp `DLL độc hại`.

![image](assets/images8/18.png)

Tiếp tục nhấn `F9`, thấy được dừng tại hàm `LoadLibraryW`: Xác nhận tiến trình `McAfee.exe` đang thực hiện nạp tệp độc hại `McUtil.dll` vào bộ nhớ

![image](assets/images8/19.png)
  
  - Dấu hiệu: Tham số đầu tiên trên Stack `([esp+4])` trỏ thẳng đến đường dẫn của tệp `McUtil.dll`

Nhấn `Ctrl F9` để chạy nốt hàm nạp thư viện và dừng lại ở lệnh `ret` (trở về)

![image](assets/images8/20.png)

Sau khi nạp xong DLL, tiến trình thực hiện `jmp` trực tiếp từ file thực thi hợp lệ `McAfee.exe` vào hàm độc hại `mcutil.10001000` 

![image](assets/images8/21.png)

Ta đã vào được luồng thực thi của `McUtil.dll` giống như những gì đã thấy được khi phân tích mã giả trong `IDA`

![image](assets/images8/22.png)


![image](assets/images8/23.png)

- Hành vi kỹ thuật: Mã độc thực hiện vòng lặp quét ngược (Backwards scan) chuỗi đường dẫn của McAfee.exe để tìm ký tự gạch chéo \
- Mục đích: Tách phần tên tệp thực thi `McAfee.exe` ra khỏi đường dẫn đầy đủ để xác định thư mục làm việc.
- Kết quả: Ngay sau vòng lặp này tại `10001072`, mã độc sẽ ghép tên tệp `McUtil.dll.mc` vào vị trí đó. Điều này giúp mã độc luôn tìm thấy tệp payload đi kèm bất kể nó được đặt ở thư mục nào trên máy nạn nhân.

Vì ta đã biết được mã độc sẽ sử dụng `VirtualAlloc` để tạo một vùng nhớ trống, nên ta sẽ đặt một `breakpoint` vào đúng hàm này bằng lệnh `bp VirtualAlloc`

![image](assets/images8/24.png)

Nhấn `F9` để chạy thằng đến hàm đó 

![image](assets/images8/25.png)

`Ctrl F9` để chạy hết hàm cấp phát vùng nhớ, sau đó luồng thực thi sẽ di chuyển vào giai đoạn chuẩn bị các tham số cho hàm `RtlDecompressBuffer` để giải nén `payload` thật sự từ tệp `.mc` vào vùng nhớ vừa được cấp phát

![image](assets/images8/26.png)

Quan sát giá trị thanh ghi `EAX` vừa được cấp phát là `006D0000`, ta sẽ follow theo vùng nhớ này

![image](assets/images8/27.png)

Tiếp tục `F8` đến hết hàm `RtlDecompressBuffer` tức là `shellcode` sẽ được giải mã và ghi vào vùng nhớ `006D0000`

![image](assets/images8/28.png)

Thấy có dấu hiệu ban đầu là header không phải là `MZ`, nên mình đã thử kéo xuống xem phần thân bên dưới thì đã thấy có sự xuất hiện của các `API hệ thống` được gọi

![image](assets/images8/29.png)

Nội dung sau khi giải của vùng nhớ thực chất là một tệp `PE` hoàn chỉnh, nhưng các giá trị đặc trưng ở phần `Header` đã bị làm biến dạng để tránh bị phát hiện của `AV`. Cụ thể, các dấu hiệu nhận biết tiêu chuẩn như `MZ` và `PE` đã được thay thế bằng ký tự `XV`. Ta có thể check nó bằng `die`

![image](assets/images8/30.png)

Dùng `PEstudio` để check `Strings`, thấy được cảnh báo của `virustotal` là 56/72 chứng tỏ ta đã dump được chính xác `payload` và `payload` này đã được sử dụng rất nhiều cho các cuộc tấn công

![image](assets/images8/35.png)

- Giao tiếp mạng: `InternetConnect`, `HttpOpenRequest`, `HttpSendRequestEx`, `HttpQueryInfo`, ... . Những chuỗi này cho thấy mã độc có khả năng kết nối và gửi dữ liệu đến máy chủ điều khiển (C2).

- Thao tác hệ thống: `CreateFile`, `ReadFile`, `WriteFile`, `SetFileAttributes`. Các API này củng cố giả thuyết ban đầu về hành vi tạo file và thiết lập thuộc tính ẩn trong thư mục `C:\ProgramData\McAfee `để duy trì sự hiện diện (Persistence).

- Quản lý tiến trình: `CreateProcess`, `TerminateProcess`, `OpenProcess`, gợi ý khả năng mã độc có thể tiêm nhiễm (inject) vào các tiến trình hệ thống khác để lẩn trốn.

Quay trở lại với luồng phân tích từ `x32Dbg`, thay vì để hệ điều hành nạp file, mã độc sử dụng vòng lặp `memcpy` để tự ánh xạ (Manual Mapping) từng phân đoạn của tệp `PE` vào bộ nhớ ảo. Bằng cách tự xây dựng cấu trúc `PE` thủ công và sử dụng `header` giả, mã độc dễ dàng lẩn trốn các cơ chế giám sát hành vi nạp file thực thi tiêu chuẩn của Windows.

![image](assets/images8/31.png)

Thấy được một vùng nhớ mới được cấp phát tại thanh ghi `EAX` là `021A1000`, ta tiến hành chạy hết vòng lặp kết hợp với `follow` vùng nhớ đó để ra được `payload` cuối cùng. Chạy xong, luồng thực thi quay lại với luồng của `McUtil.dll`. Thực hiện lệnh gọi cuối `call ecx` trước khi rơi vào trạng thái `Sleep`

![image](assets/images8/33.png)

Dump file xóa hết null ta được file `PE` chuẩn

![image](assets/images8/34.png)

Tiếp tục dùng `PEstudio` để kiểm tra `Strings`, nhận thấy đúng như những gì ở những phần phân tích trước đó

![image](assets/images8/36.png)

- Xác nhận máy chủ điều khiển (C2 Server): `asia.dcsvn.org`
- Giao thức: Sử dụng bộ thư viện WinInet `(InternetConnect, HttpOpenRequest, HttpSendRequestEx) để truyền tải dữ liệu qua HTTP/HTTPS`.
- Thám mã mạng: Các hàm `WNetOpenEnum`, `WNetEnumResource` cho phép liệt kê tài nguyên và máy trạm trong mạng nội bộ (`Lateral Movement`).
- Trích xuất dữ liệu: Tích hợp bộ `API SQL` (`SQLDriverConnect`, `SQLExecDirect`) hỗ trợ truy vấn trực tiếp vào các cơ sở dữ liệu nội bộ của nạn nhân.
- Thu thập thông tin thiết bị: Sử dụng `GetAdaptersInfo` và `gethostbyname` để lấy cấu hình mạng và định danh máy `(Fingerprinting)`.
- Duy trì quyền kiểm soát: Sử dụng `CreateProcess` và đường dẫn giả mạo `%AUTO%\McAfee` để thực thi mã từ xa và ẩn mình dưới danh nghĩa ứng dụng bảo mật.

### Luồng tái tạo mã độc

![image](assets/images8/37.png)

## MITRE ATT&CK

| Tactic (Chiến thuật) | ID | Technique (Kỹ thuật) | Mô tả chi tiết hành vi (Technical Evidence) |
| :--- | :--- | :--- | :--- |
| **Persistence** | T1547.001 | Registry Run Keys | Ghi khóa `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` trỏ tới `C:\ProgramData\McAfee\McAfee.exe` để tự khởi động. |
| **Defense Evasion** | **T1564.001** | **Hidden Files and Directories** | Thiết lập thuộc tính **System (S)** và **Hidden (H)** cho thư mục `C:\ProgramData\McAfee` bằng lệnh `attrib` để tránh bị phát hiện bởi File Explorer. |
| | T1574.002 | **DLL Side-loading** | Lợi dụng tiến trình sạch `McAfee.exe` để nạp thư viện độc hại `McUtil.dll`. |
| | T1055.012 | **Process Hollowing** | Tiêm mã độc vào tiến trình hệ thống `svchost.exe` (PID 6856) để lẩn trốn trong danh sách tiến trình. |
| | T1620 | Reflective Code Loading | Tự ánh xạ (Manual Mapping) tệp PE vào RAM qua vòng lặp `memcpy`, thay đổi quyền vùng nhớ thành **RWX**. |
| | T1027 | Obfuscated Files | Sử dụng tệp payload `.mc` và giả mạo PE Header thành ký tự **"XV"** để qua mặt các trình quét chữ ký. |
| | T1497.003 | Time-Based Evasion | Sử dụng hàm `Sleep(-1)` và `GetSystemTime` để gây nhiễu và làm treo các môi trường Sandbox/Debugger. |
| **Discovery** | T1046 | Network Service Scanning | Quét dải mạng nội bộ qua cổng **TCP 1357** để tìm kiếm các mục tiêu lây lan tiềm năng. |
| | T1135 | Network Share Discovery | Sử dụng API `WNetOpenEnum` và `WNetEnumResource` để liệt kê tài nguyên mạng LAN. |
| | T1082 | System Information Discovery | Thu thập thông tin cấu hình mạng và định danh thiết bị qua `GetAdaptersInfo` và `gethostbyname`. |
| **Command & Control**| T1071.001 | Web Protocols | Sử dụng giao thức **HTTP GET** (không mã hóa) qua cổng **443** để gửi tín hiệu về máy chủ điều khiển. |
| | T1568.002 | DNS Discovery | Thực hiện truy vấn tên miền C2: **`asia.dcsvn.org`**. |
| **Collection** | T1005 | Data from Local System | Sử dụng các API SQL (`SQLExecDirect`) để truy vấn và trích xuất dữ liệu từ cơ sở dữ liệu nội bộ của nạn nhân. |

---

## IOCs

### 1. File Indicators (Artifacts)

| Tên tệp / Thành phần | SHA256 Hash | Đặc điểm nhận dạng & Vai trò |
| :--- | :--- | :--- |
| **McAfee.exe** | `3124FCB79DA0BDF9D0D1995E37B06F7929D83C1C4B60E38C104743BE71170EFE` | Tệp thực thi sạch, có chữ ký số. Đóng vai trò làm "vùng đệm" kích hoạt kỹ thuật DLL Side-loading. |
| **McUtil.dll** | `b04d5b8d83246acef2fa3553bdaa16ee212a20090c0524a1e3db6a583732e4af` | Thư viện độc hại (Loader), không có chữ ký số. Nhiệm vụ chính là giải nén và nạp tệp payload `.mc`. |
| **McUtil.dll.mc** | `58648fed34d7617c3217af047f331cb8e16012b8ae7d4fdebf77e31f6fa79cb5` | Tệp chứa shellcode đã bị làm rối (Obfuscated)|
| **Unpacked Payload** | `c22e1765b185d5dd8dc5d6251d49f7133831398c9ef0ea9910cc5998bdb1ad27` | Payload  được trích xuất ra sau khi đã hoàn tất giải mã|

---

### 2. Network Indicators

#### Command & Control (C2) Infrastructure
* **Domain:** `asia.dcsvn.org`
* **IP Addresses:**
    * `76.223.54.146`
    * `13.248.169.48`
* **Protocol:** HTTP (Cleartext)
* **Destination Port:** `443`
* **Behavior:** Gửi yêu cầu `HTTP GET` tới C2 Server qua cổng 443 nhằm qua mặt tường lửa bằng cách giả mạo cổng HTTPS.
* **User-Agent**: `Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 10.0; .NET4.0C; .NET4.0E)`


#### Lateral Movement / Reconnaissance
* **Target Port:** `1357` (TCP)
* **Activity:** Quét dải IP nội bộ (`192.168.129.x`) từ tiến trình bị tiêm nhiễm.
* **API Usage:** `WNetOpenEnum`, `WNetEnumResource` để liệt kê tài nguyên mạng.

---

### 3. Host-Based Indicators (HBI)

#### Persistence Mechanism
* **File System Path:** `C:\ProgramData\McAfee\`
* **Attributes:** Hidden (H) và System (S) (Thiết lập qua lệnh `attrib`).
* **Registry Key:** `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
* **Registry Value:** `McAfee` -> `"C:\ProgramData\McAfee\McAfee.exe"`

#### Process Behavior
* **Process Injection:** `McAfee.exe` sử dụng **Process Hollowing** để tiêm mã độc vào `C:\Windows\SysWOW64\svchost.exe`.
* **Memory Allocation:** Sử dụng `VirtualAlloc` và `VirtualProtect` để tạo vùng nhớ **RWX** (`PAGE_EXECUTE_READWRITE`).

---

### 4. Technical Observations
* **Custom PE Header:** Payload cuối cùng thay đổi Header chuẩn `MZ/PE` thành `XV` nhằm mục đích lẩn trốn các công cụ phân tích tĩnh thông thường.
* **Self-Mapping:** Thay vì sử dụng Loader của Windows, mã độc tự thực hiện vòng lặp `memcpy` để ánh xạ các phân đoạn của tệp PE vào RAM.
* **SQL API Integration:** Việc xuất hiện các API như `SQLDriverConnect` cho thấy mã độc có khả năng tương tác và trích xuất dữ liệu trực tiếp từ các hệ quản trị cơ sở dữ liệu.
